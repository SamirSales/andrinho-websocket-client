<!DOCTYPE html>
<html>
<head>
    <title>Hello WebSocket</title>    
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js" integrity="sha256-h8Ya2I6WFlKs3CpjVZ3MwGh8XKjbxvLAdP0Cg8wIG9w=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js" integrity="sha256-4jNHNewFZSwkUiWXCfjQ0erj6guZPNAjfiJQiBHk4K4=" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <style>
        #accordionTwo {
            display: none;
        }
    </style>

</head>
<body>

<div id="main-content" class="container">
    <br/>
    <div class="row">
        <div class="col-6">
            <div class="input-group">
                <input type="text" class="form-control" id="txtValue" placeholder="Ticket" aria-label="Ticket">
                <button class="btn btn-outline-primary" id="btnConnect" type="button" onclick="connect()">Connect</button>
                <button class="btn btn-outline-danger" id="btnDisconnect" type="button" onclick="disconnect()">Disconnect</button>
            </div>
        </div>
    </div>

    <hr/>

    <div class="row">
        <div class="accordion" id="accordionExample">
            <div id="accordionTwo" class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Accordion Item #2
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script type="text/javascript">

function test(process) {
    let accordionTwo = $("#accordionTwo");

    let totalElements = $("#accordionExample > div.accordion-item").length;

    let processData = JSON.parse(process.processData);    

    let clone = accordionTwo.clone();
    clone.attr("id", "accordion-"+totalElements);

    let cloneHeading = clone.find("#headingTwo");
    cloneHeading.attr("id", "heading-"+totalElements);

    let cloneAccordionButton = cloneHeading.find("button.accordion-button");
    cloneAccordionButton.html("<strong>" + totalElements + "&nbsp;-</strong> <strong>&nbsp;Id:&nbsp;</strong> " + process.id + " <strong>&nbsp;Operation:&nbsp;</strong> " + process.operationType + " <strong>&nbsp;Status:&nbsp;</strong> " + process.status);
    cloneAccordionButton.attr("data-bs-target", "#collapse-"+totalElements);
    cloneAccordionButton.attr("aria-controls", "collapse-"+totalElements);


    let cloneCollapseTwo = clone.find("#collapseTwo");
    cloneCollapseTwo.attr("id", "collapse-"+totalElements);
    cloneCollapseTwo.attr("aria-labelledby", "heading-"+totalElements);

    let cloneAccordionBody  = cloneCollapseTwo.find("div.accordion-body");
    cloneAccordionBody.html(process.processData);
    
    clone.insertAfter("#accordionTwo");
}

	var stompClient = null;

function setConnected(connected) {
    $("#btnConnect").prop("disabled", connected);
    $("#btnDisconnect").prop("disabled", !connected);
}

function connect() {
    var socket = new WebSocket('ws://localhost:8763');
    let textValue = $("#txtValue").val();

    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, function (frame) {
        setConnected(true);
        stompClient.subscribe('/ticket/'+textValue, function (result) {            
            showTicket(result.body);
        });

    });

    stompClient.connect({}, function (frame) {
        setConnected(true);
        stompClient.subscribe('/ticket/'+textValue+'/process', function (result) {            
            showTicketProcess(result.body);
        });

    });    
}

function disconnect() {
    if (stompClient !== null) {
        stompClient.disconnect();
    }
    setConnected(false);
    console.log("Disconnected");
}

function showTicketProcess(message) {
    let process = JSON.parse(message);
    test(process);
}

function showTicket(message) {
    let ticket = JSON.parse(message);
    console.log("ticket", ticket);
}

$(function () {
    $("form").on('submit', function (e) {
        e.preventDefault();
    });
    $( "#connect" ).click(function() { connect(); });
    $( "#disconnect" ).click(function() { disconnect(); });
});	
</script>

</html>